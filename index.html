<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Call Break Online</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
html,body{
  margin:0;
  padding:0;
  background:#0b3d2e;
  color:#fff;
  font-family:Arial;
  height:100%;
  overflow:hidden;
}
#rotate{
  display:none;
  position:fixed;
  inset:0;
  background:#000;
  z-index:999;
  align-items:center;
  justify-content:center;
  font-size:22px;
}
@media (orientation:portrait){
  #rotate{display:flex}
}
button{
  padding:10px 20px;
  font-size:18px;
  border:none;
  border-radius:6px;
}
#screen{
  padding:10px;
}
.card{
  display:inline-block;
  padding:8px 10px;
  margin:4px;
  background:#fff;
  color:#000;
  border-radius:6px;
  font-weight:bold;
}
</style>
</head>

<body>
<div id="rotate">üì± Rotate phone to Landscape</div>
<div id="screen"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// üî• FIREBASE CONFIG (change this)
firebase.initializeApp({apiKey: "AIzaSyDKKAxKTFJcMDmj6j21nKHwlSpwAxsw57k",
            authDomain: "call-breke.firebaseapp.com",
            databaseURL: "https://call-breke-default-rtdb.firebaseio.com",
            projectId: "call-breke",
            storageBucket: "call-breke.firebasestorage.app",
            messagingSenderId: "908751603046",
            appId: "1:908751603046:web:fd30e07b9e6400b35c74a7",
            measurementId: "G-V2D55S47QV" 
});
const db = firebase.database();

const screen = document.getElementById("screen");
let playerId = "P"+Math.floor(Math.random()*10000);
let roomId = "";
let myIndex = -1;

function home(){
  screen.innerHTML=`
    <h2>üÉè Call Break Online</h2>
    <button onclick="createRoom()">Create Room</button><br><br>
    <input id="roomInput" placeholder="Room Code">
    <button onclick="joinRoom()">Join</button>
  `;
}
home();

function createRoom(){
  roomId = Math.random().toString(36).substring(2,7).toUpperCase();
  db.ref("rooms/"+roomId).set({
    players:{},
    phase:"waiting"
  });
  join(roomId);
}

function joinRoom(){
  const code = document.getElementById("roomInput").value.trim();
  if(code) join(code);
}

function join(code){
  roomId = code;
  const ref = db.ref("rooms/"+roomId+"/players");
  ref.once("value",snap=>{
    if(snap.numChildren()>=4){
      alert("Room Full");
      return;
    }
    myIndex = snap.numChildren();
    ref.child(playerId).set({
      index:myIndex,
      score:0
    });
    lobby();
  });
}

function lobby(){
  screen.innerHTML=`<h3>Room: ${roomId}</h3><p>Waiting players...</p>`;
  db.ref("rooms/"+roomId+"/players").on("value",snap=>{
    const n = snap.numChildren();
    screen.innerHTML=`<h3>Room: ${roomId}</h3><p>Players: ${n}/4</p>`;
    if(n===4 && myIndex===0){
      startGame();
    }
  });
}

function startGame(){
  const deck=[];
  ["S","H","D","C"].forEach(s=>{
    ["A","K","Q","J","10","9","8","7","6","5","4","3","2"].forEach(v=>{
      deck.push(v+s);
    });
  });
  deck.sort(()=>Math.random()-0.5);

  db.ref("rooms/"+roomId).update({
    deck:deck,
    phase:"call",
    turn:0,
    calls:{},
    table:{}
  });
}

db.ref("rooms").on("value",snap=>{
  if(!roomId) return;
  const room = snap.child(roomId).val();
  if(!room) return;
  if(room.phase==="call") callPhase();
  if(room.phase==="play") playPhase(room);
});

function callPhase(){
  screen.innerHTML=`
    <h3>Call Phase</h3>
    <input id="callNum" type="number" min="1" max="13">
    <button onclick="submitCall()">Submit</button>
  `;
}

function submitCall(){
  const c = document.getElementById("callNum").value;
  if(!c) return;
  db.ref("rooms/"+roomId+"/calls/"+playerId).set(Number(c));
  db.ref("rooms/"+roomId+"/calls").once("value",snap=>{
    if(snap.numChildren()===4){
      db.ref("rooms/"+roomId).update({phase:"play"});
    }
  });
}

function playPhase(room){
  const myCards = room.deck.slice(myIndex*13,(myIndex+1)*13);
  screen.innerHTML="<h3>Your Cards</h3>";
  myCards.forEach(c=>{
    const d=document.createElement("div");
    d.className="card";
    d.innerText=c;
    d.onclick=()=>playCard(c);
    screen.appendChild(d);
  });
}

function playCard(card){
  db.ref("rooms/"+roomId+"/table/"+playerId).set(card);
}

</script>
</body>
</html>
